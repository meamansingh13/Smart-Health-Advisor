<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Emotional Support Chat</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
      body { background-color: #f7fbff; font-family: 'Nunito', sans-serif; }
      .chat-container { max-width: 900px; margin: 40px auto; }
      .messages { height: 60vh; overflow-y: auto; padding: 1rem; background: white; border-radius: 12px; box-shadow: 0 6px 20px rgba(16,24,40,0.08); }
      .message { margin-bottom: 12px; }
      .message.user { text-align: right; }
      .bubble { display: inline-block; padding: 10px 14px; border-radius: 12px; max-width: 75%; }
      .bubble.bot { background: linear-gradient(180deg,#e9f4fb,#d7eefc); color: #073b55; }
      .bubble.user { background: #007bff; color: white; }
      .loader { display: inline-block; height: 18px; width: 18px; border: 3px solid #cfe9ff; border-top-color: #007bff; border-radius: 50%; animation: spin 1s linear infinite; }
      @keyframes spin { to { transform: rotate(360deg); } }
      .disclaimer { font-size: 0.9rem; color: #555; margin-top: 0.5rem; }
    </style>
  </head>
  <body>
    <div class="container chat-container">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h3 class="m-0">Emotional Support</h3>
        <a href="/" class="btn btn-outline-secondary">Back</a>
      </div>

      <div class="messages p-3" id="messages">
        <div class="message bot">
          <div class="bubble bot">Hi â€” I'm here to listen. You can share how you're feeling. If this is an emergency, contact local emergency services immediately.</div>
        </div>
      </div>

      <div class="mt-3">
        <div class="input-group">
          <input type="text" id="chatInput" class="form-control" placeholder="Type how you're feeling or ask for help...">
          <button class="btn btn-primary" id="sendBtn">Send</button>
        </div>
        <div class="disclaimer mt-2">This chat provides supportive conversation and resources. It is not a substitute for professional mental health care.</div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      const messagesEl = document.getElementById('messages');
      const inputEl = document.getElementById('chatInput');
      const sendBtn = document.getElementById('sendBtn');

      function appendMessage(text, who='bot'){
        const wrapper = document.createElement('div');
        wrapper.className = 'message ' + (who==='user' ? 'user' : 'bot');
        const bubble = document.createElement('div');
        bubble.className = 'bubble ' + (who==='user' ? 'user' : 'bot');
        bubble.innerText = text;
        wrapper.appendChild(bubble);
        messagesEl.appendChild(wrapper);
        messagesEl.scrollTop = messagesEl.scrollHeight;
      }

      async function sendMessage(){
        const text = inputEl.value.trim();
        if(!text) return;
        appendMessage(text, 'user');
        inputEl.value = '';

        // show loader bubble
        const loaderWrapper = document.createElement('div');
        loaderWrapper.className = 'message bot';
        const loaderBubble = document.createElement('div');
        loaderBubble.className = 'bubble bot';
        loaderBubble.innerHTML = '<span class="loader" aria-hidden="true"></span> Thinking...';
        loaderWrapper.appendChild(loaderBubble);
        messagesEl.appendChild(loaderWrapper);
        messagesEl.scrollTop = messagesEl.scrollHeight;

        try{
          const resp = await fetch('/chat_api', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message: text })
          });

          // remove loader
          messagesEl.removeChild(loaderWrapper);

          if(!resp.ok){
            appendMessage('Sorry, there was an error processing your message. Please try again later.','bot');
            return;
          }

          const data = await resp.json();
          if(data && data.reply) appendMessage(data.reply, 'bot');
        } catch(e){
          // remove loader
          try{ messagesEl.removeChild(loaderWrapper); } catch(e){}
          appendMessage('Network error. Please check your connection.','bot');
        }
      }

      sendBtn.addEventListener('click', sendMessage);
      inputEl.addEventListener('keydown', (e)=>{ if(e.key==='Enter') sendMessage(); });
    </script>
  </body>
</html>
